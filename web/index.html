<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>relayctl</title>
</head>
<body>
  <h1>Relays</h1>
  <label for="addRelayGPIO">GPIO:</label>
  <input type="number" id="addRelayGPIO" style="width: 60px;">
  <button type="button" onclick="addRelay()">Add</button>
  <br>
  <span style="display: none;" id="addRelayStatus"></span>
  <br>
  <br>
  <table>
    <th>ID</th><th>GPIO</th><th>Status</th><th>Action</th><th>Remove</th>
    <tbody id="relays-data"></tbody>

  </table>
  <h1>Switches</h1>

  <h1>Scedules</h1>
</body>

<script>
  async function getRelays() {
    let url = '/relays';
    try {
        let res = await fetch(url);
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function relayTable() {
    let relays = await getRelays();
    let html = '';
    relays.forEach(relay => {
        if (relay.status == 0) {
          sw_button = `<button type="button" onclick="switchRelay('on', ${relay.relay})">Switch</button>`
        } else {
          sw_button = `<button type="button" onclick="switchRelay('off', ${relay.relay})">Switch</button>`
        }
        let htmlSegment = `<tr>
                            <td>${relay.relay}</td>
                            <td>${relay.gpio}</td>
                            <td>${relay.status}</td>
                            <td>${sw_button}</td>
                            <td><button type="button" onclick="removeRelay(${relay.relay})">Remove</button></td>
                          </tr>`;

        html += htmlSegment;
    });

    let container = document.getElementById('relays-data');
    container.innerHTML = html;
  }

  async function addRelaysRes(gpio_pin) {
    let url = '/relays/add';
    data = JSON.stringify({"gpio": parseInt(gpio_pin)})
    try {
        let res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: data
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function addRelay() {
    //let gpio = 32
    let gpio = input = document.getElementById("addRelayGPIO").value;
    let add = await addRelaysRes(gpio);
    
    if (add.status == "add") {
      document.getElementById("addRelayStatus").style = "color: green;";
      document.getElementById("addRelayStatus").innerHTML = ` Added new relay ID: ${add.id}`;
    }

    relayTable()
  }

  async function switchRelay(mode, id) {

    if (mode == "off") {
      url = `/relays/${id}/off`;
      try {
        let res = await fetch(url);
      } catch (error) {
          console.log(error);
      }
    }
    
    if (mode == "on") {
      url = `/relays/${id}/on`;
      try {
        let res = await fetch(url);
      } catch (error) {
          console.log(error);
      }
    }
    relayTable()
  }
  
  async function removeRelayRes(id) {
    let url = `/relays/delete/${id}`;
    try {
        let res = await fetch(url, {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'}
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function removeRelay(relay_id) {
    
    let remove = await removeRelayRes(relay_id);
    
    if (remove.status == "delete") {
      document.getElementById("addRelayStatus").style = "color: red;";
      document.getElementById("addRelayStatus").innerHTML = ` Relay ID: ${remove.id} removed`;
    }

    relayTable()
  }

  relayTable()

</script>

</html>