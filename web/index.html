<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>relayctl</title>
</head>
<body>
  <h1>Relays</h1>
  <label for="addRelayGPIO">GPIO:</label>
  <input type="number" id="addRelayGPIO" style="width: 60px;">
  <button type="button" onclick="addRelay()">Add</button>
  <br>
  <span style="display: none;" id="addRelayStatus"></span>
  <br>
  <table>
    <th>ID</th><th>GPIO</th><th>Status</th><th>Action</th><th>Remove</th>
    <tbody id="relays-data"></tbody>
  </table>

  <h1>Switches</h1>
  <label for="addSwitchRID">Relay ID:</label>
  <!-- <input type="number" id="addSwitchRID" style="width: 60px;"> -->
  <select id="addSwitchRID" style="width: 60px;"></select>
  <label for="addSwitchMode">Mode:</label>
  <select id="addSwitchMode" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <!-- <input type="number" id="addSwitchMode" style="width: 60px;"> -->
  <label for="addSwitchAction">Action:</label>
  <!-- <input type="number" id="addSwitchAction" style="width: 60px;"> -->
  <select id="addSwitchAction" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <button type="button" onclick="addSwitch()">Add</button>
  <br>
  <span style="display: none;" id="addSwitchStatus"></span>
  <br>
  <table>
    <th>ID</th><th>RELAY ID</th><th>Mode</th><th>Action</th><th>Remove</th>
    <tbody id="switches-data"></tbody>
  </table>

  <h1>Schedules</h1>
  <label for="addSchedulesRID">Relay ID:</label>
  <!-- <input type="number" id="addSwitchRID" style="width: 60px;"> -->
  <select id="addSchedulesRID" style="width: 60px;"></select>
  <!-- <input type="number" id="addSwitchMode" style="width: 60px;"> -->
  <label for="addSchedulesAction">Action:</label>
  <!-- <input type="number" id="addSwitchAction" style="width: 60px;"> -->
  <select id="addSchedulesAction" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <label for="addSchedulesStart">Start Time:</label>
  <input type="time" id="addSchedulesStart" style="width: 80px;">
  <label for="addSchedulesEnd">End Time:</label>
  <input type="time" id="addSchedulesEnd" style="width: 80px;">
  <br>
  <label for="addSchedulesMon">Mon:</label>
  <select id="addSchedulesMon" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <label for="addSchedulesTue">Tue:</label>
  <select id="addSchedulesTue" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <label for="addSchedulesWed">Wed:</label>
  <select id="addSchedulesWed" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <label for="addSchedulesThu">Thu:</label>
  <select id="addSchedulesThu" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <label for="addSchedulesFri">Fri:</label>
  <select id="addSchedulesFri" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <label for="addSchedulesSat">Sat:</label>
  <select id="addSchedulesSat" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <label for="addSchedulesSun">Sun:</label>
  <select id="addSchedulesSun" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <br>
  <button type="button" onclick="addSchedules()">Add</button>
  <br>
  <span style="display: none;" id="addSchedulesStatus"></span>
  <br>
  <table>
    <th>ID</th><th>Relay ID</th><th>Action</th><th>Start</th><th>End</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
    <tbody id="schedules-data"></tbody>
  </table>
</body>

<script>
  async function getRelays() {
    let url = '/relays';
    try {
        let res = await fetch(url);
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function relayTable() {
    let relays = await getRelays();
    let html = '';
    relays.forEach(relay => {
        if (relay.status == 0) {
          sw_button = `<button type="button" onclick="switchRelay('on', ${relay.relay})">Switch On</button>`
        } else {
          sw_button = `<button type="button" onclick="switchRelay('off', ${relay.relay})">Switch Off</button>`
        }
        let htmlSegment = `<tr>
                            <td>${relay.relay}</td>
                            <td>${relay.gpio}</td>
                            <td>${relay.status}</td>
                            <td>${sw_button}</td>
                            <td><button type="button" onclick="removeRelay(${relay.relay})">Remove</button></td>
                          </tr>`;

        html += htmlSegment;
    });

    let container = document.getElementById('relays-data');
    container.innerHTML = html;
  }

  async function addRelaysRes(gpio_pin) {
    let url = '/relays/add';
    data = JSON.stringify({"gpio": parseInt(gpio_pin)})
    try {
        let res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: data
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function addRelay() {
    //let gpio = 32
    let gpio = input = document.getElementById("addRelayGPIO").value;
    let add = await addRelaysRes(gpio);
    
    if (add.status == "add") {
      document.getElementById("addRelayStatus").style = "color: green;";
      document.getElementById("addRelayStatus").innerHTML = ` Added new relay ID: ${add.id}`;
    }

    relayTable()
  }

  async function switchRelay(mode, id) {

    if (mode == "off") {
      url = `/relays/${id}/off`;
      try {
        let res = await fetch(url);
      } catch (error) {
          console.log(error);
      }
    }
    
    if (mode == "on") {
      url = `/relays/${id}/on`;
      try {
        let res = await fetch(url);
      } catch (error) {
          console.log(error);
      }
    }
    relayTable()
  }
  
  async function removeRelayRes(id) {
    let url = `/relays/delete/${id}`;
    try {
        let res = await fetch(url, {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'}
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function removeRelay(relay_id) {
    
    let remove = await removeRelayRes(relay_id);
    
    if (remove.status == "delete") {
      document.getElementById("addRelayStatus").style = "color: red;";
      document.getElementById("addRelayStatus").innerHTML = ` Relay ID: ${remove.id} removed`;
    }

    relayTable()
  }

  async function getSwicthes() {
    let url = '/switches';
    try {
        let res = await fetch(url);
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function switchTable() {
    let switches = await getSwicthes();
    let html = '';
    switches.forEach(sw => {
        let htmlSegment = `<tr>
                            <td>${sw.id}</td>
                            <td>${sw.relay_id}</td>
                            <td>${sw.mode}</td>
                            <td>${sw.action}</td>
                            <td><button type="button" onclick="removeSwitch(${sw.id})">Remove</button></td>
                          </tr>`;

        html += htmlSegment;
    });

    let container = document.getElementById('switches-data');
    container.innerHTML = html;
  }

  async function addSwitchRes(relay_id, mode, action) {
    let url = '/switches/add';
    data = JSON.stringify({"relay_id": parseInt(relay_id), "mode": parseInt(mode), "action": parseInt(action)})
    try {
        let res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: data
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function addSwitch() {
    let relay_id = input = document.getElementById("addSwitchRID").value;
    let mode = input = document.getElementById("addSwitchMode").value;
    let action = input = document.getElementById("addSwitchAction").value;

    let add = await addSwitchRes(relay_id, mode, action);
    
    if (add.status == "add") {
      document.getElementById("addSwitchStatus").style = "color: green;";
      document.getElementById("addSwitchStatus").innerHTML = ` Added Switch ID: ${add.id}`;
    }

    switchTable()
  }

  async function removeSwitchRes(id) {
    let url = `/switches/delete/${id}`;
    try {
        let res = await fetch(url, {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'}
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function removeSwitch(switch_id) {
    
    let remove = await removeSwitchRes(switch_id);
    
    if (remove.status == "delete") {
      document.getElementById("addSwitchStatus").style = "color: red;";
      document.getElementById("addSwitchStatus").innerHTML = ` Relay ID: ${remove.id} removed`;
    }

    switchTable()
  }

  //Schedules
  async function getSchedules() {
    let url = '/schedules';
    try {
        let res = await fetch(url);
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function scheduleTable() {
    let schedules = await getSchedules();
    let html = '';
    schedules.forEach(schedule => {
        let htmlSegment = `<tr>
                            <td>${schedule.id}</td>
                            <td>${schedule.relay_id}</td>
                            <td>${schedule.action}</td>
                            <td>${schedule.start}</td>
                            <td>${schedule.end}</td>
                            <td>${schedule.mon}</td>
                            <td>${schedule.tue}</td>
                            <td>${schedule.wed}</td>
                            <td>${schedule.thu}</td>
                            <td>${schedule.fri}</td>
                            <td>${schedule.sat}</td>
                            <td>${schedule.sun}</td>
                            <td><button type="button" onclick="removeSchedule(${schedule.id})">Remove</button></td>
                          </tr>`;

        html += htmlSegment;
    });

    let container = document.getElementById('schedules-data');
    container.innerHTML = html;
  }

  async function addScheduleRes(relay_id, action, start, end, mon, tue, wed, thu, fri, sat, sun) {
    let url = '/schedules/add';
    data = JSON.stringify({
      "relay_id": parseInt(relay_id),
      "action": parseInt(action),
      "start": start,
      "end": end,
      "mon": parseInt(mon),
      "tue": parseInt(tue),
      "wed": parseInt(wed),
      "thu": parseInt(thu),
      "fri": parseInt(fri),
      "sat": parseInt(sat),
      "sun": parseInt(sun)
    })
    try {
        let res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: data
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function addSchedules() {
    let relay_id = input = document.getElementById("addSchedulesRID").value;
    let action = input = document.getElementById("addSchedulesAction").value;
    let start = input = document.getElementById("addSchedulesStart").value;
    let end = input = document.getElementById("addSchedulesEnd").value;
    let mon = input = document.getElementById("addSchedulesMon").value;
    let tue = input = document.getElementById("addSchedulesTue").value;
    let wed = input = document.getElementById("addSchedulesWed").value;
    let thu = input = document.getElementById("addSchedulesThu").value;
    let fri = input = document.getElementById("addSchedulesFri").value;
    let sat = input = document.getElementById("addSchedulesSat").value;
    let sun = input = document.getElementById("addSchedulesSun").value;

    let add = await addScheduleRes(relay_id, action, start, end, mon, tue, wed, thu, fri, sat, sun);
    
    if (add.status == "add") {
      document.getElementById("addSchedulesStatus").style = "color: green;";
      document.getElementById("addSchedulesStatus").innerHTML = ` Added Switch ID: ${add.id}`;
    }

    scheduleTable()
  }

  async function removeScheduleRes(id) {
    let url = `/schedules/delete/${id}`;
    try {
        let res = await fetch(url, {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'}
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function removeSchedule(schedule_id) {
    
    let remove = await removeScheduleRes(schedule_id);
    
    if (remove.status == "delete") {
      document.getElementById("addSchedulesStatus").style = "color: red;";
      document.getElementById("addSchedulesStatus").innerHTML = ` Schedule ID: ${remove.id} removed`;
    }

    scheduleTable()
  }

  // Misc
  async function UpdateRelayIdForAdd() {
    let relays = await getRelays();
    let html = '';
    relays.forEach(relay => {
        let htmlSegment = `<option value="${relay.relay}">${relay.relay}</option>`;
        html += htmlSegment;
    });

    let switches = document.getElementById('addSwitchRID');
    switches.innerHTML = html;

    let schedules = document.getElementById('addSchedulesRID');
    schedules.innerHTML = html;
  }

  relayTable()
  switchTable()
  scheduleTable()
  UpdateRelayIdForAdd()

</script>
</html>