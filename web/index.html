<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>relayctl</title>
</head>
<body>
  <h1>Relays</h1>
  <label for="addRelayGPIO">GPIO:</label>
  <input type="number" id="addRelayGPIO" style="width: 60px;">
  <button type="button" onclick="addRelay()">Add</button>
  <br>
  <span style="display: none;" id="addRelayStatus"></span>
  <br>
  <table>
    <th>ID</th><th>GPIO</th><th>Status</th><th>Action</th><th>Remove</th>
    <tbody id="relays-data"></tbody>
  </table>

  <h1>Switches</h1>
  <label for="addSwitchRID">Relay ID:</label>
  <!-- <input type="number" id="addSwitchRID" style="width: 60px;"> -->
  <select id="addSwitchRID" style="width: 60px;"></select>
  <label for="addSwitchMode">Mode:</label>
  <select id="addSwitchMode" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <!-- <input type="number" id="addSwitchMode" style="width: 60px;"> -->
  <label for="addSwitchAction">Action:</label>
  <!-- <input type="number" id="addSwitchAction" style="width: 60px;"> -->
  <select id="addSwitchAction" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <button type="button" onclick="addSwitch()">Add</button>
  <br>
  <span style="display: none;" id="addSwitchStatus"></span>
  <br>
  <table>
    <th>ID</th><th>RELAY ID</th><th>Mode</th><th>Action</th><th>Remove</th>
    <tbody id="switches-data"></tbody>
  </table>

  <h1>Scedules</h1>
</body>

<script>
  async function getRelays() {
    let url = '/relays';
    try {
        let res = await fetch(url);
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function relayTable() {
    let relays = await getRelays();
    let html = '';
    relays.forEach(relay => {
        if (relay.status == 0) {
          sw_button = `<button type="button" onclick="switchRelay('on', ${relay.relay})">Switch On</button>`
        } else {
          sw_button = `<button type="button" onclick="switchRelay('off', ${relay.relay})">Switch Off</button>`
        }
        let htmlSegment = `<tr>
                            <td>${relay.relay}</td>
                            <td>${relay.gpio}</td>
                            <td>${relay.status}</td>
                            <td>${sw_button}</td>
                            <td><button type="button" onclick="removeRelay(${relay.relay})">Remove</button></td>
                          </tr>`;

        html += htmlSegment;
    });

    let container = document.getElementById('relays-data');
    container.innerHTML = html;
  }

  async function addRelaysRes(gpio_pin) {
    let url = '/relays/add';
    data = JSON.stringify({"gpio": parseInt(gpio_pin)})
    try {
        let res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: data
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function addRelay() {
    //let gpio = 32
    let gpio = input = document.getElementById("addRelayGPIO").value;
    let add = await addRelaysRes(gpio);
    
    if (add.status == "add") {
      document.getElementById("addRelayStatus").style = "color: green;";
      document.getElementById("addRelayStatus").innerHTML = ` Added new relay ID: ${add.id}`;
    }

    relayTable()
  }

  async function switchRelay(mode, id) {

    if (mode == "off") {
      url = `/relays/${id}/off`;
      try {
        let res = await fetch(url);
      } catch (error) {
          console.log(error);
      }
    }
    
    if (mode == "on") {
      url = `/relays/${id}/on`;
      try {
        let res = await fetch(url);
      } catch (error) {
          console.log(error);
      }
    }
    relayTable()
  }
  
  async function removeRelayRes(id) {
    let url = `/relays/delete/${id}`;
    try {
        let res = await fetch(url, {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'}
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function removeRelay(relay_id) {
    
    let remove = await removeRelayRes(relay_id);
    
    if (remove.status == "delete") {
      document.getElementById("addRelayStatus").style = "color: red;";
      document.getElementById("addRelayStatus").innerHTML = ` Relay ID: ${remove.id} removed`;
    }

    relayTable()
  }

  async function getSwicthes() {
    let url = '/switches';
    try {
        let res = await fetch(url);
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function switchTable() {
    let switches = await getSwicthes();
    let html = '';
    switches.forEach(sw => {
        let htmlSegment = `<tr>
                            <td>${sw.id}</td>
                            <td>${sw.relay_id}</td>
                            <td>${sw.mode}</td>
                            <td>${sw.action}</td>
                            <td><button type="button" onclick="removeSwitch(${sw.id})">Remove</button></td>
                          </tr>`;

        html += htmlSegment;
    });

    let container = document.getElementById('switches-data');
    container.innerHTML = html;
  }

  async function swUpdateRelayIdForAdd() {
    let relays = await getRelays();
    let html = '';
    relays.forEach(relay => {
        let htmlSegment = `<option value="${relay.relay}">${relay.relay}</option>`;
        html += htmlSegment;
    });

    let container = document.getElementById('addSwitchRID');
    container.innerHTML = html;
  }

  async function addSwitchRes(relay_id, mode, action) {
    let url = '/switches/add';
    data = JSON.stringify({"relay_id": parseInt(relay_id), "mode": parseInt(mode), "action": parseInt(action)})
    try {
        let res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: data
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function addSwitch() {
    let relay_id = input = document.getElementById("addSwitchRID").value;
    let mode = input = document.getElementById("addSwitchMode").value;
    let action = input = document.getElementById("addSwitchAction").value;

    let add = await addSwitchRes(relay_id, mode, action);
    
    if (add.status == "add") {
      document.getElementById("addSwitchStatus").style = "color: green;";
      document.getElementById("addSwitchStatus").innerHTML = ` Added Switch ID: ${add.id}`;
    }

    switchTable()
  }

  async function removeSwitchRes(id) {
    let url = `/switches/delete/${id}`;
    try {
        let res = await fetch(url, {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'}
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function removeSwitch(switch_id) {
    
    let remove = await removeSwitchRes(switch_id);
    
    if (remove.status == "delete") {
      document.getElementById("addSwitchStatus").style = "color: red;";
      document.getElementById("addSwitchStatus").innerHTML = ` Relay ID: ${remove.id} removed`;
    }

    switchTable()
  }

  relayTable()
  switchTable()
  swUpdateRelayIdForAdd()

</script>
</html>