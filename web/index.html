<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>relayctl</title>
  <style>

    div.form {
      width: 460px;
      background-color: red;
    }

    div.form-lable {
      width: 60px;
    }

    div.form-input {
      width: 200px;
    }

    div.form-button {
      width: 100px;
    }

    label.form {
      background-color: aqua;
    }

    input.form {
      background-color: cadetblue;
    }
  </style>
</head>
<body>

  <h1>Relays</h1>

  <label class="form" for="addRelayGPIO">GPIO:</label>
  <input class="form" type="number" id="addRelayGPIO">
  <button class="form" type="button" onclick="addRelay()">Add</button><span style="display: none;" id="addRelayStatus"></span>
  
  <table>
    <th>ID</th><th>GPIO</th><th>Status</th><th>Action</th><th>Remove</th>
    <tbody id="relays-data"></tbody>
  </table>

  <h1>Switches</h1>
  <label class="form" for="addSwitchGPIO">GPIO:</label>
  <input class="form" type="number" id="addSwitchGPIO"><br>
  <label for="addSwitchRID">Relay ID:</label>
  <select id="addSwitchRID" style="width: 60px;"></select><br>
  <label for="addSwitchAction">Action:</label>
  <select id="addSwitchAction" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select><br>
  <button type="button" onclick="addSwitch()">Add</button><span style="display: none;" id="addSwitchStatus"></span><br>
  <br>
  <table>
    <th>ID</th><th>GPIO</th><th>RELAY ID</th><th>Action</th><th>Status</th><th>Remove</th>
    <tbody id="switches-data"></tbody>
  </table>

  <h1>Schedules</h1>
  <label for="addSchedulesRID">Relay ID:</label>
  <select id="addSchedulesRID" style="width: 60px;"></select>
  <label for="addSchedulesAction">Action:</label>
  <select id="addSchedulesAction" style="width: 60px;">
    <option value="1">on</option>
    <option value="0">off</option>
  </select>
  <label for="addSchedulesStart">Start Time:</label>
  <input type="time" id="addSchedulesStart" style="width: 80px;">
  <label for="addSchedulesEnd">End Time:</label>
  <input type="time" id="addSchedulesEnd" style="width: 80px;">
  <br>
  <button type="button" onclick="addSchedules()">Add</button>
  <br>
  <span style="display: none;" id="addSchedulesStatus"></span>
  <br>
  <table>
    <th>ID</th><th>Relay ID</th><th>Action</th><th>Start</th><th>End</th><th>Remove</th>
    <tbody id="schedules-data"></tbody>
  </table>
</body>

<script>
  // API Functions
  async function apiGet(url) {
    try {
        let res = await fetch(url);
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function apiAdd(url, json) {
    data = JSON.stringify(json)
    try {
        let res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: data
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  async function apiRm(url, id) {
    try {
        let res = await fetch(url + id, {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'}
        });
        return await res.json();
    } catch (error) {
        console.log(error);
    }
  }

  // Relays Functions
  async function relayTable() {
    let relays = await apiGet('/relays');
    let html = '';
    relays.forEach(relay => {
        if (relay.status == 0) {
          sw_button = `<button type="button" onclick="switchRelay('on', ${relay.relay})">Switch On</button>`
        } else {
          sw_button = `<button type="button" onclick="switchRelay('off', ${relay.relay})">Switch Off</button>`
        }
        let htmlSegment = `<tr>
                            <td>${relay.relay}</td>
                            <td>${relay.gpio}</td>
                            <td>${relay.status}</td>
                            <td>${sw_button}</td>
                            <td><button type="button" onclick="removeRelay(${relay.relay})">Remove</button></td>
                          </tr>`;

        html += htmlSegment;
    });

    let container = document.getElementById('relays-data');
    container.innerHTML = html;
  }

  async function addRelay() {
    
    let gpio = input = document.getElementById("addRelayGPIO").value;
    let add = await apiAdd('/relays/add', {"gpio": parseInt(gpio)});
    
    if (add.status == "add") {
      document.getElementById("addRelayStatus").style = "color: green;";
      document.getElementById("addRelayStatus").innerHTML = ` Added new relay ID: ${add.id}`;
    }

    relayTable()
    UpdateRelayIdForAdd()
  }

  async function switchRelay(mode, id) {

    if (mode == "off") {
      url = `/relays/${id}/off`;
      try {
        let res = await fetch(url);
      } catch (error) {
          console.log(error);
      }
    }
    
    if (mode == "on") {
      url = `/relays/${id}/on`;
      try {
        let res = await fetch(url);
      } catch (error) {
          console.log(error);
      }
    }
    relayTable()
  }
  
  async function removeRelay(id) {
    
    let remove = await apiRm('/relays/delete/', id);
    
    if (remove.status == "delete") {
      document.getElementById("addRelayStatus").style = "color: red;";
      document.getElementById("addRelayStatus").innerHTML = ` Relay ID: ${remove.id} removed`;
    }

    relayTable()
    UpdateRelayIdForAdd()
  }

  // Switches Functions
  async function switchTable() {
    let switches = await apiGet('/switches');
    let html = '';
    switches.forEach(sw => {
        let htmlSegment = `<tr>
                            <td>${sw.id}</td>
                            <td>${sw.gpio}</td>
                            <td>${sw.relay_id}</td>
                            <td>${sw.action}</td>
                            <td>${sw.status}</td>
                            <td><button type="button" onclick="removeSwitch(${sw.id})">Remove</button></td>
                          </tr>`;

        html += htmlSegment;
    });

    let container = document.getElementById('switches-data');
    container.innerHTML = html;
  }

  async function addSwitch() {
    let relay_id = input = document.getElementById("addSwitchRID").value;
    let mode = input = document.getElementById("addSwitchMode").value;
    let action = input = document.getElementById("addSwitchAction").value;
    let gpio = input = document.getElementById("addSwitchGPIO").value;

    let add = await apiAdd('/switches/add', {
      "relay_id": parseInt(relay_id),
      "mode": parseInt(mode),
      "action": parseInt(action),
      "gpio": parseInt(gpio)
    });
    
    if (add.status == "add") {
      document.getElementById("addSwitchStatus").style = "color: green;";
      document.getElementById("addSwitchStatus").innerHTML = ` Added Switch ID: ${add.id}`;
    }

    switchTable()
  }

  async function removeSwitch(id) {
    
    let remove = await apiRm('/switches/delete/', id);
    
    if (remove.status == "delete") {
      document.getElementById("addSwitchStatus").style = "color: red;";
      document.getElementById("addSwitchStatus").innerHTML = ` Relay ID: ${remove.id} removed`;
    }

    switchTable()
  }

  //Schedules Functions
  async function scheduleTable() {
    let schedules = await apiGet('/schedules');
    let html = '';
    schedules.forEach(schedule => {
        let htmlSegment = `<tr>
                            <td>${schedule.id}</td>
                            <td>${schedule.relay_id}</td>
                            <td>${schedule.action}</td>
                            <td>${schedule.start}</td>
                            <td>${schedule.end}</td>
                            <td><button type="button" onclick="removeSchedule(${schedule.id})">Remove</button></td>
                          </tr>`;

        html += htmlSegment;
    });

    let container = document.getElementById('schedules-data');
    container.innerHTML = html;
  }

  async function addSchedules() {
    let relay_id = input = document.getElementById("addSchedulesRID").value;
    let action = input = document.getElementById("addSchedulesAction").value;
    let start = input = document.getElementById("addSchedulesStart").value;
    let end = input = document.getElementById("addSchedulesEnd").value;

    let add = await apiAdd('/schedules/add', {
      "relay_id": parseInt(relay_id),
      "action": parseInt(action),
      "start": start,
      "end": end
    });
    
    if (add.status == "add") {
      document.getElementById("addSchedulesStatus").style = "color: green;";
      document.getElementById("addSchedulesStatus").innerHTML = ` Added Switch ID: ${add.id}`;
    }

    scheduleTable()
  }

  async function removeSchedule(id) {
    
    let remove = await apiRm('/schedules/delete/', id); 
    
    if (remove.status == "delete") {
      document.getElementById("addSchedulesStatus").style = "color: red;";
      document.getElementById("addSchedulesStatus").innerHTML = ` Schedule ID: ${remove.id} removed`;
    }

    scheduleTable()
  }

  // Misc Functions
  async function UpdateRelayIdForAdd() {
    let relays = await apiGet('/relays');
    let html = '';
    relays.forEach(relay => {
        let htmlSegment = `<option value="${relay.relay}">${relay.relay}</option>`;
        html += htmlSegment;
    });

    let switches = document.getElementById('addSwitchRID');
    switches.innerHTML = html;

    let schedules = document.getElementById('addSchedulesRID');
    schedules.innerHTML = html;
  }

  relayTable()
  switchTable()
  scheduleTable()
  UpdateRelayIdForAdd()

</script>
</html>